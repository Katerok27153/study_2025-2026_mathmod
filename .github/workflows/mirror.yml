name: Mirror to GitVerse

on:
  push:
    branches: [ main, master ]
    tags: [ '*' ]
  release:
    types: [published, edited]
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        fetch-tags: true
    
    - name: Push to GitVerse
      run: |
        git remote add gitverse https://${{ secrets.GITVERSE_TOKEN }}@gitverse.ru/Katerok27153/study_2025-2026_mathmod.git
        
 	# Получаем актуальное состояние
        git fetch --all
        
        # Отправляем все ветки, кроме master, с force-with-lease
        echo "Pushing non-master branches..."
        for branch in $(git branch -r | grep -v "HEAD" | grep -v "master" | grep -v "main" | sed 's/origin\///'); do
          if [ ! -z "$branch" ]; then
            echo "Pushing branch: $branch"
            git push gitverse origin/$branch:$branch --force-with-lease || \
            git push gitverse origin/$branch:$branch --force
          fi
        done
        
        # Отправляем main если есть
        echo "Pushing main branch..."
        git push gitverse origin/main:main --force-with-lease || \
        git push gitverse origin/main:main --force || \
        echo "main not found or push failed"
        
        # Отправляем master с force (так как это защищенная ветка)
        echo "Pushing master branch..."
        git push gitverse origin/master:master --force || \
        echo "master not found"
        
        # Отправляем теги
        echo "Pushing tags..."
        git push gitverse --tags --force
